!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("cross-fetch")):"function"==typeof define&&define.amd?define(["cross-fetch"],t):"object"==typeof exports?exports.ca=t(require("cross-fetch")):e.ca=t(e.fetch)}("undefined"!=typeof self?self:this,(function(__WEBPACK_EXTERNAL_MODULE__268__){return function(){var __webpack_modules__={601:function(module,__unused_webpack_exports,__webpack_require__){var factory;factory=function(){"use strict";var commonjsGlobal="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==__webpack_require__.g?__webpack_require__.g:"undefined"!=typeof self?self:{};function createCommonjsModule(e,t){return e(t={exports:{}},t.exports),t.exports}function getCjsExportFromNamespace(e){return e&&e.default||e}var runtime=createCommonjsModule((function(e){!function(t){var n,r=Object.prototype,i=r.hasOwnProperty,s="function"==typeof Symbol?Symbol:{},o=s.iterator||"@@iterator",a=s.asyncIterator||"@@asyncIterator",c=s.toStringTag||"@@toStringTag",u=t.regeneratorRuntime;if(u)e.exports=u;else{(u=t.regeneratorRuntime=e.exports).wrap=g;var l="suspendedStart",h="suspendedYield",_="executing",p="completed",d={},f={};f[o]=function(){return this};var v=Object.getPrototypeOf,y=v&&v(v(S([])));y&&y!==r&&i.call(y,o)&&(f=y);var m=x.prototype=k.prototype=Object.create(f);w.prototype=m.constructor=x,x.constructor=w,x[c]=w.displayName="GeneratorFunction",u.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===w||"GeneratorFunction"===(t.displayName||t.name))},u.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,x):(e.__proto__=x,c in e||(e[c]="GeneratorFunction")),e.prototype=Object.create(m),e},u.awrap=function(e){return{__await:e}},R(E.prototype),E.prototype[a]=function(){return this},u.AsyncIterator=E,u.async=function(e,t,n,r){var i=new E(g(e,t,n,r));return u.isGeneratorFunction(t)?i:i.next().then((function(e){return e.done?e.value:i.next()}))},R(m),m[c]="Generator",m[o]=function(){return this},m.toString=function(){return"[object Generator]"},u.keys=function(e){var t=[];for(var n in e)t.push(n);return t.reverse(),function n(){for(;t.length;){var r=t.pop();if(r in e)return n.value=r,n.done=!1,n}return n.done=!0,n}},u.values=S,T.prototype={constructor:T,reset:function(e){if(this.prev=0,this.next=0,this.sent=this._sent=n,this.done=!1,this.delegate=null,this.method="next",this.arg=n,this.tryEntries.forEach(O),!e)for(var t in this)"t"===t.charAt(0)&&i.call(this,t)&&!isNaN(+t.slice(1))&&(this[t]=n)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(e){if(this.done)throw e;var t=this;function r(r,i){return a.type="throw",a.arg=e,t.next=r,i&&(t.method="next",t.arg=n),!!i}for(var s=this.tryEntries.length-1;s>=0;--s){var o=this.tryEntries[s],a=o.completion;if("root"===o.tryLoc)return r("end");if(o.tryLoc<=this.prev){var c=i.call(o,"catchLoc"),u=i.call(o,"finallyLoc");if(c&&u){if(this.prev<o.catchLoc)return r(o.catchLoc,!0);if(this.prev<o.finallyLoc)return r(o.finallyLoc)}else if(c){if(this.prev<o.catchLoc)return r(o.catchLoc,!0)}else{if(!u)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return r(o.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var r=this.tryEntries[n];if(r.tryLoc<=this.prev&&i.call(r,"finallyLoc")&&this.prev<r.finallyLoc){var s=r;break}}s&&("break"===e||"continue"===e)&&s.tryLoc<=t&&t<=s.finallyLoc&&(s=null);var o=s?s.completion:{};return o.type=e,o.arg=t,s?(this.method="next",this.next=s.finallyLoc,d):this.complete(o)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),d},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),O(n),d}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;O(n)}return i}}throw new Error("illegal catch attempt")},delegateYield:function(e,t,r){return this.delegate={iterator:S(e),resultName:t,nextLoc:r},"next"===this.method&&(this.arg=n),d}}}function g(e,t,n,r){var i=t&&t.prototype instanceof k?t:k,s=Object.create(i.prototype),o=new T(r||[]);return s._invoke=function(e,t,n){var r=l;return function(i,s){if(r===_)throw new Error("Generator is already running");if(r===p){if("throw"===i)throw s;return $()}for(n.method=i,n.arg=s;;){var o=n.delegate;if(o){var a=C(o,n);if(a){if(a===d)continue;return a}}if("next"===n.method)n.sent=n._sent=n.arg;else if("throw"===n.method){if(r===l)throw r=p,n.arg;n.dispatchException(n.arg)}else"return"===n.method&&n.abrupt("return",n.arg);r=_;var c=b(e,t,n);if("normal"===c.type){if(r=n.done?p:h,c.arg===d)continue;return{value:c.arg,done:n.done}}"throw"===c.type&&(r=p,n.method="throw",n.arg=c.arg)}}}(e,n,o),s}function b(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}function k(){}function w(){}function x(){}function R(e){["next","throw","return"].forEach((function(t){e[t]=function(e){return this._invoke(t,e)}}))}function E(e){function t(n,r,s,o){var a=b(e[n],e,r);if("throw"!==a.type){var c=a.arg,u=c.value;return u&&"object"==typeof u&&i.call(u,"__await")?Promise.resolve(u.__await).then((function(e){t("next",e,s,o)}),(function(e){t("throw",e,s,o)})):Promise.resolve(u).then((function(e){c.value=e,s(c)}),(function(e){return t("throw",e,s,o)}))}o(a.arg)}var n;this._invoke=function(e,r){function i(){return new Promise((function(n,i){t(e,r,n,i)}))}return n=n?n.then(i,i):i()}}function C(e,t){var r=e.iterator[t.method];if(r===n){if(t.delegate=null,"throw"===t.method){if(e.iterator.return&&(t.method="return",t.arg=n,C(e,t),"throw"===t.method))return d;t.method="throw",t.arg=new TypeError("The iterator does not provide a 'throw' method")}return d}var i=b(r,e.iterator,t.arg);if("throw"===i.type)return t.method="throw",t.arg=i.arg,t.delegate=null,d;var s=i.arg;return s?s.done?(t[e.resultName]=s.value,t.next=e.nextLoc,"return"!==t.method&&(t.method="next",t.arg=n),t.delegate=null,d):s:(t.method="throw",t.arg=new TypeError("iterator result is not an object"),t.delegate=null,d)}function I(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function T(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(I,this),this.reset(!0)}function S(e){if(e){var t=e[o];if(t)return t.call(e);if("function"==typeof e.next)return e;if(!isNaN(e.length)){var r=-1,s=function t(){for(;++r<e.length;)if(i.call(e,r))return t.value=e[r],t.done=!1,t;return t.value=n,t.done=!0,t};return s.next=s}}return{next:$}}function $(){return{value:n,done:!0}}}(function(){return this||"object"==typeof self&&self}()||Function("return this")())}));function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function asyncGeneratorStep(e,t,n,r,i,s,o){try{var a=e[s](o),c=a.value}catch(e){return void n(e)}a.done?t(c):Promise.resolve(c).then(r,i)}function _asyncToGenerator(e){return function(){var t=this,n=arguments;return new Promise((function(r,i){var s=e.apply(t,n);function o(e){asyncGeneratorStep(s,r,i,o,a,"next",e)}function a(e){asyncGeneratorStep(s,r,i,o,a,"throw",e)}o(void 0)}))}}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,n){return t&&_defineProperties(e.prototype,t),n&&_defineProperties(e,n),e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(e){return!1}}function _construct(e,t,n){return _construct=isNativeReflectConstruct()?Reflect.construct:function(e,t,n){var r=[null];r.push.apply(r,t);var i=new(Function.bind.apply(e,r));return n&&_setPrototypeOf(i,n.prototype),i},_construct.apply(null,arguments)}function _isNativeFunction(e){return-1!==Function.toString.call(e).indexOf("[native code]")}function _wrapNativeSuper(e){var t="function"==typeof Map?new Map:void 0;return _wrapNativeSuper=function(e){if(null===e||!_isNativeFunction(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return _construct(e,arguments,_getPrototypeOf(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),_setPrototypeOf(n,e)},_wrapNativeSuper(e)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _slicedToArray(e,t){return _arrayWithHoles(e)||_iterableToArrayLimit(e,t)||_nonIterableRest()}function _toArray(e){return _arrayWithHoles(e)||_iterableToArray(e)||_nonIterableRest()}function _toConsumableArray(e){return _arrayWithoutHoles(e)||_iterableToArray(e)||_nonIterableSpread()}function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}function _arrayWithHoles(e){if(Array.isArray(e))return e}function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}function _iterableToArrayLimit(e,t){var n=[],r=!0,i=!1,s=void 0;try{for(var o,a=e[Symbol.iterator]();!(r=(o=a.next()).done)&&(n.push(o.value),!t||n.length!==t);r=!0);}catch(e){i=!0,s=e}finally{try{r||null==a.return||a.return()}finally{if(i)throw s}}return n}function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}var load=function(e,t){var n,r,i,s=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};for(n in t)i=t[n],s[n]=null!=(r=e[n])?r:i;return s},overwrite=function(e,t){var n,r,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};for(n in e)r=e[n],void 0!==t[n]&&(i[n]=r);return i},parser={load:load,overwrite:overwrite},DLList;DLList=function(){function e(t,n){_classCallCheck(this,e),this.incr=t,this.decr=n,this._first=null,this._last=null,this.length=0}return _createClass(e,[{key:"push",value:function(e){var t;this.length++,"function"==typeof this.incr&&this.incr(),t={value:e,prev:this._last,next:null},null!=this._last?(this._last.next=t,this._last=t):this._first=this._last=t}},{key:"shift",value:function(){var e;if(null!=this._first)return this.length--,"function"==typeof this.decr&&this.decr(),e=this._first.value,null!=(this._first=this._first.next)?this._first.prev=null:this._last=null,e}},{key:"first",value:function(){if(null!=this._first)return this._first.value}},{key:"getArray",value:function(){var e,t,n;for(e=this._first,n=[];null!=e;)n.push((t=e,e=e.next,t.value));return n}},{key:"forEachShift",value:function(e){var t;for(t=this.shift();null!=t;)e(t),t=this.shift()}},{key:"debug",value:function(){var e,t,n,r,i;for(e=this._first,i=[];null!=e;)i.push((t=e,e=e.next,{value:t.value,prev:null!=(n=t.prev)?n.value:void 0,next:null!=(r=t.next)?r.value:void 0}));return i}}]),e}();var DLList_1=DLList,Events;Events=function(){function e(t){var n=this;if(_classCallCheck(this,e),this.instance=t,this._events={},null!=this.instance.on||null!=this.instance.once||null!=this.instance.removeAllListeners)throw new Error("An Emitter already exists for this object");this.instance.on=function(e,t){return n._addListener(e,"many",t)},this.instance.once=function(e,t){return n._addListener(e,"once",t)},this.instance.removeAllListeners=function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;return null!=e?delete n._events[e]:n._events={}}}var t;return _createClass(e,[{key:"_addListener",value:function(e,t,n){var r;return null==(r=this._events)[e]&&(r[e]=[]),this._events[e].push({cb:n,status:t}),this.instance}},{key:"listenerCount",value:function(e){return null!=this._events[e]?this._events[e].length:0}},{key:"trigger",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var n,r,i,s,o,a=this,c=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:for(n=c.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=c[i];if(e.prev=1,"debug"!==t&&this.trigger("debug","Event triggered: ".concat(t),r),null!=this._events[t]){e.next=5;break}return e.abrupt("return");case 5:return this._events[t]=this._events[t].filter((function(e){return"none"!==e.status})),o=this._events[t].map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var n,i;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("none"!==t.status){e.next=2;break}return e.abrupt("return");case 2:if("once"===t.status&&(t.status="none"),e.prev=3,"function"!=typeof(null!=(i="function"==typeof t.cb?t.cb.apply(t,r):void 0)?i.then:void 0)){e.next=11;break}return e.next=8,i;case 8:return e.abrupt("return",e.sent);case 11:return e.abrupt("return",i);case 12:e.next=19;break;case 14:return e.prev=14,e.t0=e.catch(3),n=e.t0,a.trigger("error",n),e.abrupt("return",null);case 19:case"end":return e.stop()}}),e,null,[[3,14]])})));return function(t){return e.apply(this,arguments)}}()),e.next=9,Promise.all(o);case 9:return e.t0=function(e){return null!=e},e.abrupt("return",e.sent.find(e.t0));case 13:return e.prev=13,e.t1=e.catch(1),s=e.t1,this.trigger("error",s),e.abrupt("return",null);case 18:case"end":return e.stop()}}),e,this,[[1,13]])}))),function(e){return t.apply(this,arguments)})}]),e}();var Events_1=Events,DLList$1,Events$1,Queues;DLList$1=DLList_1,Events$1=Events_1,Queues=function(){function e(t){_classCallCheck(this,e),this.Events=new Events$1(this),this._length=0,this._lists=function(){var e,n,r,i=this;for(r=[],e=1,n=t;1<=n?e<=n:e>=n;1<=n?++e:--e)r.push(new DLList$1((function(){return i.incr()}),(function(){return i.decr()})));return r}.call(this)}return _createClass(e,[{key:"incr",value:function(){if(0==this._length++)return this.Events.trigger("leftzero")}},{key:"decr",value:function(){if(0==--this._length)return this.Events.trigger("zero")}},{key:"push",value:function(e){return this._lists[e.options.priority].push(e)}},{key:"queued",value:function(e){return null!=e?this._lists[e].length:this._length}},{key:"shiftAll",value:function(e){return this._lists.forEach((function(t){return t.forEachShift(e)}))}},{key:"getFirst",value:function(){var e,t,n,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._lists;for(e=0,t=r.length;e<t;e++)if((n=r[e]).length>0)return n;return[]}},{key:"shiftLastFrom",value:function(e){return this.getFirst(this._lists.slice(e).reverse()).shift()}}]),e}();var Queues_1=Queues,BottleneckError;BottleneckError=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,_getPrototypeOf(t).apply(this,arguments))}return _inherits(t,e),t}(_wrapNativeSuper(Error));var BottleneckError_1=BottleneckError,BottleneckError$1,DEFAULT_PRIORITY,Job,NUM_PRIORITIES,parser$1;NUM_PRIORITIES=10,DEFAULT_PRIORITY=5,parser$1=parser,BottleneckError$1=BottleneckError_1,Job=function(){function e(t,n,r,i,s,o,a,c){var u=this;_classCallCheck(this,e),this.task=t,this.args=n,this.rejectOnDrop=s,this.Events=o,this._states=a,this.Promise=c,this.options=parser$1.load(r,i),this.options.priority=this._sanitizePriority(this.options.priority),this.options.id===i.id&&(this.options.id="".concat(this.options.id,"-").concat(this._randomIndex())),this.promise=new this.Promise((function(e,t){u._resolve=e,u._reject=t})),this.retryCount=0}var t,n;return _createClass(e,[{key:"_sanitizePriority",value:function(e){var t;return(t=~~e!==e?DEFAULT_PRIORITY:e)<0?0:t>NUM_PRIORITIES-1?NUM_PRIORITIES-1:t}},{key:"_randomIndex",value:function(){return Math.random().toString(36).slice(2)}},{key:"doDrop",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.error,n=e.message,r=void 0===n?"This job has been dropped by Bottleneck":n;return!!this._states.remove(this.options.id)&&(this.rejectOnDrop&&this._reject(null!=t?t:new BottleneckError$1(r)),this.Events.trigger("dropped",{args:this.args,options:this.options,task:this.task,promise:this.promise}),!0)}},{key:"_assertStatus",value:function(e){var t;if((t=this._states.jobStatus(this.options.id))!==e&&("DONE"!==e||null!==t))throw new BottleneckError$1("Invalid job status ".concat(t,", expected ").concat(e,". Please open an issue at https://github.com/SGrondin/bottleneck/issues"))}},{key:"doReceive",value:function(){return this._states.start(this.options.id),this.Events.trigger("received",{args:this.args,options:this.options})}},{key:"doQueue",value:function(e,t){return this._assertStatus("RECEIVED"),this._states.next(this.options.id),this.Events.trigger("queued",{args:this.args,options:this.options,reachedHWM:e,blocked:t})}},{key:"doRun",value:function(){return 0===this.retryCount?(this._assertStatus("QUEUED"),this._states.next(this.options.id)):this._assertStatus("EXECUTING"),this.Events.trigger("scheduled",{args:this.args,options:this.options})}},{key:"doExecute",value:(n=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n,r,i){var s,o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return 0===this.retryCount?(this._assertStatus("RUNNING"),this._states.next(this.options.id)):this._assertStatus("EXECUTING"),o={args:this.args,options:this.options,retryCount:this.retryCount},this.Events.trigger("executing",o),e.prev=3,e.next=6,null!=t?t.schedule.apply(t,[this.options,this.task].concat(_toConsumableArray(this.args))):this.task.apply(this,_toConsumableArray(this.args));case 6:if(a=e.sent,!n()){e.next=13;break}return this.doDone(o),e.next=11,i(this.options,o);case 11:return this._assertStatus("DONE"),e.abrupt("return",this._resolve(a));case 13:e.next=19;break;case 15:return e.prev=15,e.t0=e.catch(3),s=e.t0,e.abrupt("return",this._onFailure(s,o,n,r,i));case 19:case"end":return e.stop()}}),e,this,[[3,15]])}))),function(e,t,r,i){return n.apply(this,arguments)})},{key:"doExpire",value:function(e,t,n){var r,i;return this._states.jobStatus("RUNNING"===this.options.id)&&this._states.next(this.options.id),this._assertStatus("EXECUTING"),i={args:this.args,options:this.options,retryCount:this.retryCount},r=new BottleneckError$1("This job timed out after ".concat(this.options.expiration," ms.")),this._onFailure(r,i,e,t,n)}},{key:"_onFailure",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n,r,i,s){var o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r()){e.next=16;break}return e.next=3,this.Events.trigger("failed",t,n);case 3:if(null==(o=e.sent)){e.next=11;break}return a=~~o,this.Events.trigger("retry","Retrying ".concat(this.options.id," after ").concat(a," ms"),n),this.retryCount++,e.abrupt("return",i(a));case 11:return this.doDone(n),e.next=14,s(this.options,n);case 14:return this._assertStatus("DONE"),e.abrupt("return",this._reject(t));case 16:case"end":return e.stop()}}),e,this)}))),function(e,n,r,i,s){return t.apply(this,arguments)})},{key:"doDone",value:function(e){return this._assertStatus("EXECUTING"),this._states.next(this.options.id),this.Events.trigger("done",e)}}]),e}();var Job_1=Job,BottleneckError$2,LocalDatastore,parser$2;parser$2=parser,BottleneckError$2=BottleneckError_1,LocalDatastore=function(){function e(t,n,r){_classCallCheck(this,e),this.instance=t,this.storeOptions=n,this.clientId=this.instance._randomIndex(),parser$2.load(r,r,this),this._nextRequest=this._lastReservoirRefresh=this._lastReservoirIncrease=Date.now(),this._running=0,this._done=0,this._unblockTime=0,this.ready=this.Promise.resolve(),this.clients={},this._startHeartbeat()}var t,n,r,i,s,o,a,c,u,l,h,_,p;return _createClass(e,[{key:"_startHeartbeat",value:function(){var e,t=this;return null==this.heartbeat&&(null!=this.storeOptions.reservoirRefreshInterval&&null!=this.storeOptions.reservoirRefreshAmount||null!=this.storeOptions.reservoirIncreaseInterval&&null!=this.storeOptions.reservoirIncreaseAmount)?"function"==typeof(e=this.heartbeat=setInterval((function(){var e,n,r,i,s;if(i=Date.now(),null!=t.storeOptions.reservoirRefreshInterval&&i>=t._lastReservoirRefresh+t.storeOptions.reservoirRefreshInterval&&(t._lastReservoirRefresh=i,t.storeOptions.reservoir=t.storeOptions.reservoirRefreshAmount,t.instance._drainAll(t.computeCapacity())),null!=t.storeOptions.reservoirIncreaseInterval&&i>=t._lastReservoirIncrease+t.storeOptions.reservoirIncreaseInterval){var o=t.storeOptions;if(e=o.reservoirIncreaseAmount,r=o.reservoirIncreaseMaximum,s=o.reservoir,t._lastReservoirIncrease=i,(n=null!=r?Math.min(e,r-s):e)>0)return t.storeOptions.reservoir+=n,t.instance._drainAll(t.computeCapacity())}}),this.heartbeatInterval)).unref?e.unref():void 0:clearInterval(this.heartbeat)}},{key:"__publish__",value:(p=_asyncToGenerator(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return e.abrupt("return",this.instance.Events.trigger("message",t.toString()));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return p.apply(this,arguments)})},{key:"__disconnect__",value:(_=_asyncToGenerator(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return clearInterval(this.heartbeat),e.abrupt("return",this.Promise.resolve());case 4:case"end":return e.stop()}}),e,this)}))),function(e){return _.apply(this,arguments)})},{key:"yieldLoop",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return new this.Promise((function(t,n){return setTimeout(t,e)}))}},{key:"computePenalty",value:function(){var e;return null!=(e=this.storeOptions.penalty)?e:15*this.storeOptions.minTime||5e3}},{key:"__updateSettings__",value:(h=_asyncToGenerator(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return parser$2.overwrite(t,t,this.storeOptions),this._startHeartbeat(),this.instance._drainAll(this.computeCapacity()),e.abrupt("return",!0);case 6:case"end":return e.stop()}}),e,this)}))),function(e){return h.apply(this,arguments)})},{key:"__running__",value:(l=_asyncToGenerator(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return e.abrupt("return",this._running);case 3:case"end":return e.stop()}}),e,this)}))),function(){return l.apply(this,arguments)})},{key:"__queued__",value:(u=_asyncToGenerator(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return e.abrupt("return",this.instance.queued());case 3:case"end":return e.stop()}}),e,this)}))),function(){return u.apply(this,arguments)})},{key:"__done__",value:(c=_asyncToGenerator(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return e.abrupt("return",this._done);case 3:case"end":return e.stop()}}),e,this)}))),function(){return c.apply(this,arguments)})},{key:"__groupCheck__",value:(a=_asyncToGenerator(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return e.abrupt("return",this._nextRequest+this.timeout<t);case 3:case"end":return e.stop()}}),e,this)}))),function(e){return a.apply(this,arguments)})},{key:"computeCapacity",value:function(){var e,t,n=this.storeOptions;return e=n.maxConcurrent,t=n.reservoir,null!=e&&null!=t?Math.min(e-this._running,t):null!=e?e-this._running:null!=t?t:null}},{key:"conditionsCheck",value:function(e){var t;return null==(t=this.computeCapacity())||e<=t}},{key:"__incrementReservoir__",value:(o=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return n=this.storeOptions.reservoir+=t,this.instance._drainAll(this.computeCapacity()),e.abrupt("return",n);case 5:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"__currentReservoir__",value:(s=_asyncToGenerator(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return e.abrupt("return",this.storeOptions.reservoir);case 3:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"isBlocked",value:function(e){return this._unblockTime>=e}},{key:"check",value:function(e,t){return this.conditionsCheck(e)&&this._nextRequest-t<=0}},{key:"__check__",value:(i=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var n;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return n=Date.now(),e.abrupt("return",this.check(t,n));case 4:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"__register__",value:(r=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n,r){var i,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:if(i=Date.now(),!this.conditionsCheck(n)){e.next=11;break}return this._running+=n,null!=this.storeOptions.reservoir&&(this.storeOptions.reservoir-=n),s=Math.max(this._nextRequest-i,0),this._nextRequest=i+s+this.storeOptions.minTime,e.abrupt("return",{success:!0,wait:s,reservoir:this.storeOptions.reservoir});case 11:return e.abrupt("return",{success:!1});case 12:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"strategyIsBlock",value:function(){return 3===this.storeOptions.strategy}},{key:"__submit__",value:(n=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n){var r,i,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:if(!(null!=this.storeOptions.maxConcurrent&&n>this.storeOptions.maxConcurrent)){e.next=4;break}throw new BottleneckError$2("Impossible to add a job having a weight of ".concat(n," to a limiter having a maxConcurrent setting of ").concat(this.storeOptions.maxConcurrent));case 4:return i=Date.now(),s=null!=this.storeOptions.highWater&&t===this.storeOptions.highWater&&!this.check(n,i),(r=this.strategyIsBlock()&&(s||this.isBlocked(i)))&&(this._unblockTime=i+this.computePenalty(),this._nextRequest=this._unblockTime+this.storeOptions.minTime,this.instance._dropAllQueued()),e.abrupt("return",{reachedHWM:s,blocked:r,strategy:this.storeOptions.strategy});case 9:case"end":return e.stop()}}),e,this)}))),function(e,t){return n.apply(this,arguments)})},{key:"__free__",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.yieldLoop();case 2:return this._running-=n,this._done+=n,this.instance._drainAll(this.computeCapacity()),e.abrupt("return",{running:this._running});case 6:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})}]),e}();var LocalDatastore_1=LocalDatastore,lua={"blacklist_client.lua":"local blacklist = ARGV[num_static_argv + 1]\n\nif redis.call('zscore', client_last_seen_key, blacklist) then\n  redis.call('zadd', client_last_seen_key, 0, blacklist)\nend\n\n\nreturn {}\n","check.lua":"local weight = tonumber(ARGV[num_static_argv + 1])\n\nlocal capacity = process_tick(now, false)['capacity']\nlocal nextRequest = tonumber(redis.call('hget', settings_key, 'nextRequest'))\n\nreturn conditions_check(capacity, weight) and nextRequest - now <= 0\n","conditions_check.lua":"local conditions_check = function (capacity, weight)\n  return capacity == nil or weight <= capacity\nend\n","current_reservoir.lua":"return process_tick(now, false)['reservoir']\n","done.lua":"process_tick(now, false)\n\nreturn tonumber(redis.call('hget', settings_key, 'done'))\n","free.lua":"local index = ARGV[num_static_argv + 1]\n\nredis.call('zadd', job_expirations_key, 0, index)\n\nreturn process_tick(now, false)['running']\n","get_time.lua":"redis.replicate_commands()\n\nlocal get_time = function ()\n  local time = redis.call('time')\n\n  return tonumber(time[1]..string.sub(time[2], 1, 3))\nend\n","group_check.lua":"return not (redis.call('exists', settings_key) == 1)\n","heartbeat.lua":"process_tick(now, true)\n","increment_reservoir.lua":"local incr = tonumber(ARGV[num_static_argv + 1])\n\nredis.call('hincrby', settings_key, 'reservoir', incr)\n\nlocal reservoir = process_tick(now, true)['reservoir']\n\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\nrefresh_expiration(0, 0, groupTimeout)\n\nreturn reservoir\n","init.lua":"local clear = tonumber(ARGV[num_static_argv + 1])\nlocal limiter_version = ARGV[num_static_argv + 2]\nlocal num_local_argv = num_static_argv + 2\n\nif clear == 1 then\n  redis.call('del', unpack(KEYS))\nend\n\nif redis.call('exists', settings_key) == 0 then\n  -- Create\n  local args = {'hmset', settings_key}\n\n  for i = num_local_argv + 1, #ARGV do\n    table.insert(args, ARGV[i])\n  end\n\n  redis.call(unpack(args))\n  redis.call('hmset', settings_key,\n    'nextRequest', now,\n    'lastReservoirRefresh', now,\n    'lastReservoirIncrease', now,\n    'running', 0,\n    'done', 0,\n    'unblockTime', 0,\n    'capacityPriorityCounter', 0\n  )\n\nelse\n  -- Apply migrations\n  local settings = redis.call('hmget', settings_key,\n    'id',\n    'version'\n  )\n  local id = settings[1]\n  local current_version = settings[2]\n\n  if current_version ~= limiter_version then\n    local version_digits = {}\n    for k, v in string.gmatch(current_version, \"([^.]+)\") do\n      table.insert(version_digits, tonumber(k))\n    end\n\n    -- 2.10.0\n    if version_digits[2] < 10 then\n      redis.call('hsetnx', settings_key, 'reservoirRefreshInterval', '')\n      redis.call('hsetnx', settings_key, 'reservoirRefreshAmount', '')\n      redis.call('hsetnx', settings_key, 'lastReservoirRefresh', '')\n      redis.call('hsetnx', settings_key, 'done', 0)\n      redis.call('hset', settings_key, 'version', '2.10.0')\n    end\n\n    -- 2.11.1\n    if version_digits[2] < 11 or (version_digits[2] == 11 and version_digits[3] < 1) then\n      if redis.call('hstrlen', settings_key, 'lastReservoirRefresh') == 0 then\n        redis.call('hmset', settings_key,\n          'lastReservoirRefresh', now,\n          'version', '2.11.1'\n        )\n      end\n    end\n\n    -- 2.14.0\n    if version_digits[2] < 14 then\n      local old_running_key = 'b_'..id..'_running'\n      local old_executing_key = 'b_'..id..'_executing'\n\n      if redis.call('exists', old_running_key) == 1 then\n        redis.call('rename', old_running_key, job_weights_key)\n      end\n      if redis.call('exists', old_executing_key) == 1 then\n        redis.call('rename', old_executing_key, job_expirations_key)\n      end\n      redis.call('hset', settings_key, 'version', '2.14.0')\n    end\n\n    -- 2.15.2\n    if version_digits[2] < 15 or (version_digits[2] == 15 and version_digits[3] < 2) then\n      redis.call('hsetnx', settings_key, 'capacityPriorityCounter', 0)\n      redis.call('hset', settings_key, 'version', '2.15.2')\n    end\n\n    -- 2.17.0\n    if version_digits[2] < 17 then\n      redis.call('hsetnx', settings_key, 'clientTimeout', 10000)\n      redis.call('hset', settings_key, 'version', '2.17.0')\n    end\n\n    -- 2.18.0\n    if version_digits[2] < 18 then\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseInterval', '')\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseAmount', '')\n      redis.call('hsetnx', settings_key, 'reservoirIncreaseMaximum', '')\n      redis.call('hsetnx', settings_key, 'lastReservoirIncrease', now)\n      redis.call('hset', settings_key, 'version', '2.18.0')\n    end\n\n  end\n\n  process_tick(now, false)\nend\n\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\nrefresh_expiration(0, 0, groupTimeout)\n\nreturn {}\n","process_tick.lua":"local process_tick = function (now, always_publish)\n\n  local compute_capacity = function (maxConcurrent, running, reservoir)\n    if maxConcurrent ~= nil and reservoir ~= nil then\n      return math.min((maxConcurrent - running), reservoir)\n    elseif maxConcurrent ~= nil then\n      return maxConcurrent - running\n    elseif reservoir ~= nil then\n      return reservoir\n    else\n      return nil\n    end\n  end\n\n  local settings = redis.call('hmget', settings_key,\n    'id',\n    'maxConcurrent',\n    'running',\n    'reservoir',\n    'reservoirRefreshInterval',\n    'reservoirRefreshAmount',\n    'lastReservoirRefresh',\n    'reservoirIncreaseInterval',\n    'reservoirIncreaseAmount',\n    'reservoirIncreaseMaximum',\n    'lastReservoirIncrease',\n    'capacityPriorityCounter',\n    'clientTimeout'\n  )\n  local id = settings[1]\n  local maxConcurrent = tonumber(settings[2])\n  local running = tonumber(settings[3])\n  local reservoir = tonumber(settings[4])\n  local reservoirRefreshInterval = tonumber(settings[5])\n  local reservoirRefreshAmount = tonumber(settings[6])\n  local lastReservoirRefresh = tonumber(settings[7])\n  local reservoirIncreaseInterval = tonumber(settings[8])\n  local reservoirIncreaseAmount = tonumber(settings[9])\n  local reservoirIncreaseMaximum = tonumber(settings[10])\n  local lastReservoirIncrease = tonumber(settings[11])\n  local capacityPriorityCounter = tonumber(settings[12])\n  local clientTimeout = tonumber(settings[13])\n\n  local initial_capacity = compute_capacity(maxConcurrent, running, reservoir)\n\n  --\n  -- Process 'running' changes\n  --\n  local expired = redis.call('zrangebyscore', job_expirations_key, '-inf', '('..now)\n\n  if #expired > 0 then\n    redis.call('zremrangebyscore', job_expirations_key, '-inf', '('..now)\n\n    local flush_batch = function (batch, acc)\n      local weights = redis.call('hmget', job_weights_key, unpack(batch))\n                      redis.call('hdel',  job_weights_key, unpack(batch))\n      local clients = redis.call('hmget', job_clients_key, unpack(batch))\n                      redis.call('hdel',  job_clients_key, unpack(batch))\n\n      -- Calculate sum of removed weights\n      for i = 1, #weights do\n        acc['total'] = acc['total'] + (tonumber(weights[i]) or 0)\n      end\n\n      -- Calculate sum of removed weights by client\n      local client_weights = {}\n      for i = 1, #clients do\n        local removed = tonumber(weights[i]) or 0\n        if removed > 0 then\n          acc['client_weights'][clients[i]] = (acc['client_weights'][clients[i]] or 0) + removed\n        end\n      end\n    end\n\n    local acc = {\n      ['total'] = 0,\n      ['client_weights'] = {}\n    }\n    local batch_size = 1000\n\n    -- Compute changes to Zsets and apply changes to Hashes\n    for i = 1, #expired, batch_size do\n      local batch = {}\n      for j = i, math.min(i + batch_size - 1, #expired) do\n        table.insert(batch, expired[j])\n      end\n\n      flush_batch(batch, acc)\n    end\n\n    -- Apply changes to Zsets\n    if acc['total'] > 0 then\n      redis.call('hincrby', settings_key, 'done', acc['total'])\n      running = tonumber(redis.call('hincrby', settings_key, 'running', -acc['total']))\n    end\n\n    for client, weight in pairs(acc['client_weights']) do\n      redis.call('zincrby', client_running_key, -weight, client)\n    end\n  end\n\n  --\n  -- Process 'reservoir' changes\n  --\n  local reservoirRefreshActive = reservoirRefreshInterval ~= nil and reservoirRefreshAmount ~= nil\n  if reservoirRefreshActive and now >= lastReservoirRefresh + reservoirRefreshInterval then\n    reservoir = reservoirRefreshAmount\n    redis.call('hmset', settings_key,\n      'reservoir', reservoir,\n      'lastReservoirRefresh', now\n    )\n  end\n\n  local reservoirIncreaseActive = reservoirIncreaseInterval ~= nil and reservoirIncreaseAmount ~= nil\n  if reservoirIncreaseActive and now >= lastReservoirIncrease + reservoirIncreaseInterval then\n    local num_intervals = math.floor((now - lastReservoirIncrease) / reservoirIncreaseInterval)\n    local incr = reservoirIncreaseAmount * num_intervals\n    if reservoirIncreaseMaximum ~= nil then\n      incr = math.min(incr, reservoirIncreaseMaximum - (reservoir or 0))\n    end\n    if incr > 0 then\n      reservoir = (reservoir or 0) + incr\n    end\n    redis.call('hmset', settings_key,\n      'reservoir', reservoir,\n      'lastReservoirIncrease', lastReservoirIncrease + (num_intervals * reservoirIncreaseInterval)\n    )\n  end\n\n  --\n  -- Clear unresponsive clients\n  --\n  local unresponsive = redis.call('zrangebyscore', client_last_seen_key, '-inf', (now - clientTimeout))\n  local unresponsive_lookup = {}\n  local terminated_clients = {}\n  for i = 1, #unresponsive do\n    unresponsive_lookup[unresponsive[i]] = true\n    if tonumber(redis.call('zscore', client_running_key, unresponsive[i])) == 0 then\n      table.insert(terminated_clients, unresponsive[i])\n    end\n  end\n  if #terminated_clients > 0 then\n    redis.call('zrem', client_running_key,         unpack(terminated_clients))\n    redis.call('hdel', client_num_queued_key,      unpack(terminated_clients))\n    redis.call('zrem', client_last_registered_key, unpack(terminated_clients))\n    redis.call('zrem', client_last_seen_key,       unpack(terminated_clients))\n  end\n\n  --\n  -- Broadcast capacity changes\n  --\n  local final_capacity = compute_capacity(maxConcurrent, running, reservoir)\n\n  if always_publish or (initial_capacity ~= nil and final_capacity == nil) then\n    -- always_publish or was not unlimited, now unlimited\n    redis.call('publish', 'b_'..id, 'capacity:'..(final_capacity or ''))\n\n  elseif initial_capacity ~= nil and final_capacity ~= nil and final_capacity > initial_capacity then\n    -- capacity was increased\n    -- send the capacity message to the limiter having the lowest number of running jobs\n    -- the tiebreaker is the limiter having not registered a job in the longest time\n\n    local lowest_concurrency_value = nil\n    local lowest_concurrency_clients = {}\n    local lowest_concurrency_last_registered = {}\n    local client_concurrencies = redis.call('zrange', client_running_key, 0, -1, 'withscores')\n\n    for i = 1, #client_concurrencies, 2 do\n      local client = client_concurrencies[i]\n      local concurrency = tonumber(client_concurrencies[i+1])\n\n      if (\n        lowest_concurrency_value == nil or lowest_concurrency_value == concurrency\n      ) and (\n        not unresponsive_lookup[client]\n      ) and (\n        tonumber(redis.call('hget', client_num_queued_key, client)) > 0\n      ) then\n        lowest_concurrency_value = concurrency\n        table.insert(lowest_concurrency_clients, client)\n        local last_registered = tonumber(redis.call('zscore', client_last_registered_key, client))\n        table.insert(lowest_concurrency_last_registered, last_registered)\n      end\n    end\n\n    if #lowest_concurrency_clients > 0 then\n      local position = 1\n      local earliest = lowest_concurrency_last_registered[1]\n\n      for i,v in ipairs(lowest_concurrency_last_registered) do\n        if v < earliest then\n          position = i\n          earliest = v\n        end\n      end\n\n      local next_client = lowest_concurrency_clients[position]\n      redis.call('publish', 'b_'..id,\n        'capacity-priority:'..(final_capacity or '')..\n        ':'..next_client..\n        ':'..capacityPriorityCounter\n      )\n      redis.call('hincrby', settings_key, 'capacityPriorityCounter', '1')\n    else\n      redis.call('publish', 'b_'..id, 'capacity:'..(final_capacity or ''))\n    end\n  end\n\n  return {\n    ['capacity'] = final_capacity,\n    ['running'] = running,\n    ['reservoir'] = reservoir\n  }\nend\n","queued.lua":"local clientTimeout = tonumber(redis.call('hget', settings_key, 'clientTimeout'))\nlocal valid_clients = redis.call('zrangebyscore', client_last_seen_key, (now - clientTimeout), 'inf')\nlocal client_queued = redis.call('hmget', client_num_queued_key, unpack(valid_clients))\n\nlocal sum = 0\nfor i = 1, #client_queued do\n  sum = sum + tonumber(client_queued[i])\nend\n\nreturn sum\n","refresh_expiration.lua":"local refresh_expiration = function (now, nextRequest, groupTimeout)\n\n  if groupTimeout ~= nil then\n    local ttl = (nextRequest + groupTimeout) - now\n\n    for i = 1, #KEYS do\n      redis.call('pexpire', KEYS[i], ttl)\n    end\n  end\n\nend\n","refs.lua":"local settings_key = KEYS[1]\nlocal job_weights_key = KEYS[2]\nlocal job_expirations_key = KEYS[3]\nlocal job_clients_key = KEYS[4]\nlocal client_running_key = KEYS[5]\nlocal client_num_queued_key = KEYS[6]\nlocal client_last_registered_key = KEYS[7]\nlocal client_last_seen_key = KEYS[8]\n\nlocal now = tonumber(ARGV[1])\nlocal client = ARGV[2]\n\nlocal num_static_argv = 2\n","register.lua":"local index = ARGV[num_static_argv + 1]\nlocal weight = tonumber(ARGV[num_static_argv + 2])\nlocal expiration = tonumber(ARGV[num_static_argv + 3])\n\nlocal state = process_tick(now, false)\nlocal capacity = state['capacity']\nlocal reservoir = state['reservoir']\n\nlocal settings = redis.call('hmget', settings_key,\n  'nextRequest',\n  'minTime',\n  'groupTimeout'\n)\nlocal nextRequest = tonumber(settings[1])\nlocal minTime = tonumber(settings[2])\nlocal groupTimeout = tonumber(settings[3])\n\nif conditions_check(capacity, weight) then\n\n  redis.call('hincrby', settings_key, 'running', weight)\n  redis.call('hset', job_weights_key, index, weight)\n  if expiration ~= nil then\n    redis.call('zadd', job_expirations_key, now + expiration, index)\n  end\n  redis.call('hset', job_clients_key, index, client)\n  redis.call('zincrby', client_running_key, weight, client)\n  redis.call('hincrby', client_num_queued_key, client, -1)\n  redis.call('zadd', client_last_registered_key, now, client)\n\n  local wait = math.max(nextRequest - now, 0)\n  local newNextRequest = now + wait + minTime\n\n  if reservoir == nil then\n    redis.call('hset', settings_key,\n      'nextRequest', newNextRequest\n    )\n  else\n    reservoir = reservoir - weight\n    redis.call('hmset', settings_key,\n      'reservoir', reservoir,\n      'nextRequest', newNextRequest\n    )\n  end\n\n  refresh_expiration(now, newNextRequest, groupTimeout)\n\n  return {true, wait, reservoir}\n\nelse\n  return {false}\nend\n","register_client.lua":"local queued = tonumber(ARGV[num_static_argv + 1])\n\n-- Could have been re-registered concurrently\nif not redis.call('zscore', client_last_seen_key, client) then\n  redis.call('zadd', client_running_key, 0, client)\n  redis.call('hset', client_num_queued_key, client, queued)\n  redis.call('zadd', client_last_registered_key, 0, client)\nend\n\nredis.call('zadd', client_last_seen_key, now, client)\n\nreturn {}\n","running.lua":"return process_tick(now, false)['running']\n","submit.lua":"local queueLength = tonumber(ARGV[num_static_argv + 1])\nlocal weight = tonumber(ARGV[num_static_argv + 2])\n\nlocal capacity = process_tick(now, false)['capacity']\n\nlocal settings = redis.call('hmget', settings_key,\n  'id',\n  'maxConcurrent',\n  'highWater',\n  'nextRequest',\n  'strategy',\n  'unblockTime',\n  'penalty',\n  'minTime',\n  'groupTimeout'\n)\nlocal id = settings[1]\nlocal maxConcurrent = tonumber(settings[2])\nlocal highWater = tonumber(settings[3])\nlocal nextRequest = tonumber(settings[4])\nlocal strategy = tonumber(settings[5])\nlocal unblockTime = tonumber(settings[6])\nlocal penalty = tonumber(settings[7])\nlocal minTime = tonumber(settings[8])\nlocal groupTimeout = tonumber(settings[9])\n\nif maxConcurrent ~= nil and weight > maxConcurrent then\n  return redis.error_reply('OVERWEIGHT:'..weight..':'..maxConcurrent)\nend\n\nlocal reachedHWM = (highWater ~= nil and queueLength == highWater\n  and not (\n    conditions_check(capacity, weight)\n    and nextRequest - now <= 0\n  )\n)\n\nlocal blocked = strategy == 3 and (reachedHWM or unblockTime >= now)\n\nif blocked then\n  local computedPenalty = penalty\n  if computedPenalty == nil then\n    if minTime == 0 then\n      computedPenalty = 5000\n    else\n      computedPenalty = 15 * minTime\n    end\n  end\n\n  local newNextRequest = now + computedPenalty + minTime\n\n  redis.call('hmset', settings_key,\n    'unblockTime', now + computedPenalty,\n    'nextRequest', newNextRequest\n  )\n\n  local clients_queued_reset = redis.call('hkeys', client_num_queued_key)\n  local queued_reset = {}\n  for i = 1, #clients_queued_reset do\n    table.insert(queued_reset, clients_queued_reset[i])\n    table.insert(queued_reset, 0)\n  end\n  redis.call('hmset', client_num_queued_key, unpack(queued_reset))\n\n  redis.call('publish', 'b_'..id, 'blocked:')\n\n  refresh_expiration(now, newNextRequest, groupTimeout)\nend\n\nif not blocked and not reachedHWM then\n  redis.call('hincrby', client_num_queued_key, client, 1)\nend\n\nreturn {reachedHWM, blocked, strategy}\n","update_settings.lua":"local args = {'hmset', settings_key}\n\nfor i = num_static_argv + 1, #ARGV do\n  table.insert(args, ARGV[i])\nend\n\nredis.call(unpack(args))\n\nprocess_tick(now, true)\n\nlocal groupTimeout = tonumber(redis.call('hget', settings_key, 'groupTimeout'))\nrefresh_expiration(0, 0, groupTimeout)\n\nreturn {}\n","validate_client.lua":"if not redis.call('zscore', client_last_seen_key, client) then\n  return redis.error_reply('UNKNOWN_CLIENT')\nend\n\nredis.call('zadd', client_last_seen_key, now, client)\n","validate_keys.lua":"if not (redis.call('exists', settings_key) == 1) then\n  return redis.error_reply('SETTINGS_KEY_NOT_FOUND')\nend\n"},lua$1=Object.freeze({default:lua}),require$$0=getCjsExportFromNamespace(lua$1),Scripts=createCommonjsModule((function(e,t){var n,r,i;n={refs:(r=require$$0)["refs.lua"],validate_keys:r["validate_keys.lua"],validate_client:r["validate_client.lua"],refresh_expiration:r["refresh_expiration.lua"],process_tick:r["process_tick.lua"],conditions_check:r["conditions_check.lua"],get_time:r["get_time.lua"]},t.allKeys=function(e){return["b_".concat(e,"_settings"),"b_".concat(e,"_job_weights"),"b_".concat(e,"_job_expirations"),"b_".concat(e,"_job_clients"),"b_".concat(e,"_client_running"),"b_".concat(e,"_client_num_queued"),"b_".concat(e,"_client_last_registered"),"b_".concat(e,"_client_last_seen")]},i={init:{keys:t.allKeys,headers:["process_tick"],refresh_expiration:!0,code:r["init.lua"]},group_check:{keys:t.allKeys,headers:[],refresh_expiration:!1,code:r["group_check.lua"]},register_client:{keys:t.allKeys,headers:["validate_keys"],refresh_expiration:!1,code:r["register_client.lua"]},blacklist_client:{keys:t.allKeys,headers:["validate_keys","validate_client"],refresh_expiration:!1,code:r["blacklist_client.lua"]},heartbeat:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:r["heartbeat.lua"]},update_settings:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:r["update_settings.lua"]},running:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:r["running.lua"]},queued:{keys:t.allKeys,headers:["validate_keys","validate_client"],refresh_expiration:!1,code:r["queued.lua"]},done:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:r["done.lua"]},check:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!1,code:r["check.lua"]},submit:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!0,code:r["submit.lua"]},register:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick","conditions_check"],refresh_expiration:!0,code:r["register.lua"]},free:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:r["free.lua"]},current_reservoir:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!1,code:r["current_reservoir.lua"]},increment_reservoir:{keys:t.allKeys,headers:["validate_keys","validate_client","process_tick"],refresh_expiration:!0,code:r["increment_reservoir.lua"]}},t.names=Object.keys(i),t.keys=function(e,t){return i[e].keys(t)},t.payload=function(e){var t;return t=i[e],Array.prototype.concat(n.refs,t.headers.map((function(e){return n[e]})),t.refresh_expiration?n.refresh_expiration:"",t.code).join("\n")}})),Scripts_1=Scripts.allKeys,Scripts_2=Scripts.names,Scripts_3=Scripts.keys,Scripts_4=Scripts.payload,Events$2,RedisConnection,Scripts$1,parser$3;parser$3=parser,Events$2=Events_1,Scripts$1=Scripts,RedisConnection=function(){var RedisConnection=function(){function RedisConnection(){var _this=this,options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,RedisConnection),parser$3.load(options,this.defaults,this),null==this.Redis&&(this.Redis=eval("require")("redis")),null==this.Events&&(this.Events=new Events$2(this)),this.terminated=!1,null==this.client&&(this.client=this.Redis.createClient(this.clientOptions)),this.subscriber=this.client.duplicate(),this.limiters={},this.shas={},this.ready=this.Promise.all([this._setup(this.client,!1),this._setup(this.subscriber,!0)]).then((function(){return _this._loadScripts()})).then((function(){return{client:_this.client,subscriber:_this.subscriber}}))}var _runCommand__;return _createClass(RedisConnection,[{key:"_setup",value:function(e,t){var n=this;return e.setMaxListeners(0),new this.Promise((function(r,i){return e.on("error",(function(e){return n.Events.trigger("error",e)})),t&&e.on("message",(function(e,t){var r;return null!=(r=n.limiters[e])?r._store.onMessage(e,t):void 0})),e.ready?r():e.once("ready",r)}))}},{key:"_loadScript",value:function(e){var t=this;return new this.Promise((function(n,r){var i;return i=Scripts$1.payload(e),t.client.multi([["script","load",i]]).exec((function(i,s){return null!=i?r(i):(t.shas[e]=s[0],n(s[0]))}))}))}},{key:"_loadScripts",value:function(){var e=this;return this.Promise.all(Scripts$1.names.map((function(t){return e._loadScript(t)})))}},{key:"__runCommand__",value:(_runCommand__=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var n=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready;case 2:return e.abrupt("return",new this.Promise((function(e,r){return n.client.multi([t]).exec_atomic((function(t,n){return null!=t?r(t):e(n[0])}))})));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return _runCommand__.apply(this,arguments)})},{key:"__addLimiter__",value:function(e){var t=this;return this.Promise.all([e.channel(),e.channel_client()].map((function(n){return new t.Promise((function(r,i){var s;return s=function(i){if(i===n)return t.subscriber.removeListener("subscribe",s),t.limiters[n]=e,r()},t.subscriber.on("subscribe",s),t.subscriber.subscribe(n)}))})))}},{key:"__removeLimiter__",value:function(e){var t=this;return this.Promise.all([e.channel(),e.channel_client()].map(function(){var e=_asyncToGenerator(regeneratorRuntime.mark((function e(n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.terminated){e.next=3;break}return e.next=3,new t.Promise((function(e,r){return t.subscriber.unsubscribe(n,(function(t,i){return null!=t?r(t):i===n?e():void 0}))}));case 3:return e.abrupt("return",delete t.limiters[n]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}()))}},{key:"__scriptArgs__",value:function(e,t,n,r){var i;return i=Scripts$1.keys(e,t),[this.shas[e],i.length].concat(i,n,r)}},{key:"__scriptFn__",value:function(e){return this.client.evalsha.bind(this.client)}},{key:"disconnect",value:function(){var e,t,n,r,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];for(e=0,n=(r=Object.keys(this.limiters)).length;e<n;e++)t=r[e],clearInterval(this.limiters[t]._store.heartbeat);return this.limiters={},this.terminated=!0,this.client.end(i),this.subscriber.end(i),this.Promise.resolve()}}]),RedisConnection}();return RedisConnection.prototype.datastore="redis",RedisConnection.prototype.defaults={Redis:null,clientOptions:{},client:null,Promise:Promise,Events:null},RedisConnection}.call(commonjsGlobal);var RedisConnection_1=RedisConnection,Events$3,IORedisConnection,Scripts$2,parser$4;parser$4=parser,Events$3=Events_1,Scripts$2=Scripts,IORedisConnection=function(){var IORedisConnection=function(){function IORedisConnection(){var _this=this,options=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,IORedisConnection),parser$4.load(options,this.defaults,this),null==this.Redis&&(this.Redis=eval("require")("ioredis")),null==this.Events&&(this.Events=new Events$3(this)),this.terminated=!1,null!=this.clusterNodes?(this.client=new this.Redis.Cluster(this.clusterNodes,this.clientOptions),this.subscriber=new this.Redis.Cluster(this.clusterNodes,this.clientOptions)):null!=this.client&&null==this.client.duplicate?this.subscriber=new this.Redis.Cluster(this.client.startupNodes,this.client.options):(null==this.client&&(this.client=new this.Redis(this.clientOptions)),this.subscriber=this.client.duplicate()),this.limiters={},this.ready=this.Promise.all([this._setup(this.client,!1),this._setup(this.subscriber,!0)]).then((function(){return _this._loadScripts(),{client:_this.client,subscriber:_this.subscriber}}))}var _runCommand__;return _createClass(IORedisConnection,[{key:"_setup",value:function(e,t){var n=this;return e.setMaxListeners(0),new this.Promise((function(r,i){return e.on("error",(function(e){return n.Events.trigger("error",e)})),t&&e.on("message",(function(e,t){var r;return null!=(r=n.limiters[e])?r._store.onMessage(e,t):void 0})),"ready"===e.status?r():e.once("ready",r)}))}},{key:"_loadScripts",value:function(){var e=this;return Scripts$2.names.forEach((function(t){return e.client.defineCommand(t,{lua:Scripts$2.payload(t)})}))}},{key:"__runCommand__",value:(_runCommand__=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var n,r,i,s;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready;case 2:return e.next=4,this.client.pipeline([t]).exec();case 4:return r=e.sent,i=_slicedToArray(r,1),(s=_slicedToArray(i[0],2))[0],n=s[1],e.abrupt("return",n);case 10:case"end":return e.stop()}}),e,this)}))),function(e){return _runCommand__.apply(this,arguments)})},{key:"__addLimiter__",value:function(e){var t=this;return this.Promise.all([e.channel(),e.channel_client()].map((function(n){return new t.Promise((function(r,i){return t.subscriber.subscribe(n,(function(){return t.limiters[n]=e,r()}))}))})))}},{key:"__removeLimiter__",value:function(e){var t=this;return[e.channel(),e.channel_client()].forEach(function(){var e=_asyncToGenerator(regeneratorRuntime.mark((function e(n){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t.terminated){e.next=3;break}return e.next=3,t.subscriber.unsubscribe(n);case 3:return e.abrupt("return",delete t.limiters[n]);case 4:case"end":return e.stop()}}),e)})));return function(t){return e.apply(this,arguments)}}())}},{key:"__scriptArgs__",value:function(e,t,n,r){var i;return[(i=Scripts$2.keys(e,t)).length].concat(i,n,r)}},{key:"__scriptFn__",value:function(e){return this.client[e].bind(this.client)}},{key:"disconnect",value:function(){var e,t,n,r,i=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];for(e=0,n=(r=Object.keys(this.limiters)).length;e<n;e++)t=r[e],clearInterval(this.limiters[t]._store.heartbeat);return this.limiters={},this.terminated=!0,i?this.Promise.all([this.client.quit(),this.subscriber.quit()]):(this.client.disconnect(),this.subscriber.disconnect(),this.Promise.resolve())}}]),IORedisConnection}();return IORedisConnection.prototype.datastore="ioredis",IORedisConnection.prototype.defaults={Redis:null,clientOptions:{},clusterNodes:null,client:null,Promise:Promise,Events:null},IORedisConnection}.call(commonjsGlobal);var IORedisConnection_1=IORedisConnection,BottleneckError$3,IORedisConnection$1,RedisConnection$1,RedisDatastore,parser$5;parser$5=parser,BottleneckError$3=BottleneckError_1,RedisConnection$1=RedisConnection_1,IORedisConnection$1=IORedisConnection_1,RedisDatastore=function(){function e(t,n,r){var i=this;_classCallCheck(this,e),this.instance=t,this.storeOptions=n,this.originalId=this.instance.id,this.clientId=this.instance._randomIndex(),parser$5.load(r,r,this),this.clients={},this.capacityPriorityCounters={},this.sharedConnection=null!=this.connection,null==this.connection&&(this.connection="redis"===this.instance.datastore?new RedisConnection$1({Redis:this.Redis,clientOptions:this.clientOptions,Promise:this.Promise,Events:this.instance.Events}):"ioredis"===this.instance.datastore?new IORedisConnection$1({Redis:this.Redis,clientOptions:this.clientOptions,clusterNodes:this.clusterNodes,Promise:this.Promise,Events:this.instance.Events}):void 0),this.instance.connection=this.connection,this.instance.datastore=this.connection.datastore,this.ready=this.connection.ready.then((function(e){return i.clients=e,i.runScript("init",i.prepareInitSettings(i.clearDatastore))})).then((function(){return i.connection.__addLimiter__(i.instance)})).then((function(){return i.runScript("register_client",[i.instance.queued()])})).then((function(){var e;return"function"==typeof(e=i.heartbeat=setInterval((function(){return i.runScript("heartbeat",[]).catch((function(e){return i.instance.Events.trigger("error",e)}))}),i.heartbeatInterval)).unref&&e.unref(),i.clients}))}var t,n,r,i,s,o,a,c,u;return _createClass(e,[{key:"__publish__",value:(u=_asyncToGenerator(regeneratorRuntime.mark((function e(t){var n,r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.ready;case 2:return r=e.sent,n=r.client,e.abrupt("return",n.publish(this.instance.channel(),"message:".concat(t.toString())));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return u.apply(this,arguments)})},{key:"onMessage",value:(c=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n){var r,i,s,o,a,c,u,l,h,_,p,d,f,v=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,u=n.indexOf(":"),p=[n.slice(0,u),n.slice(u+1)],s=p[1],"capacity"!==(_=p[0])){e.next=11;break}return e.next=8,this.instance._drainAll(s.length>0?~~s:void 0);case 8:case 25:case 44:return e.abrupt("return",e.sent);case 11:if("capacity-priority"!==_){e.next=37;break}if(d=s.split(":"),f=_slicedToArray(d,3),h=f[0],l=f[1],i=f[2],r=h.length>0?~~h:void 0,l!==this.clientId){e.next=28;break}return e.next=21,this.instance._drainAll(r);case 21:return o=e.sent,c=null!=r?r-(o||0):"",e.next=25,this.clients.client.publish(this.instance.channel(),"capacity-priority:".concat(c,"::").concat(i));case 28:if(""!==l){e.next=34;break}return clearTimeout(this.capacityPriorityCounters[i]),delete this.capacityPriorityCounters[i],e.abrupt("return",this.instance._drainAll(r));case 34:return e.abrupt("return",this.capacityPriorityCounters[i]=setTimeout(_asyncToGenerator(regeneratorRuntime.mark((function e(){var t;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,delete v.capacityPriorityCounters[i],e.next=4,v.runScript("blacklist_client",[l]);case 4:return e.next=6,v.instance._drainAll(r);case 6:return e.abrupt("return",e.sent);case 9:return e.prev=9,e.t0=e.catch(0),t=e.t0,e.abrupt("return",v.instance.Events.trigger("error",t));case 13:case"end":return e.stop()}}),e,null,[[0,9]])}))),1e3));case 35:e.next=45;break;case 37:if("message"!==_){e.next=41;break}return e.abrupt("return",this.instance.Events.trigger("message",s));case 41:if("blocked"!==_){e.next=45;break}return e.next=44,this.instance._dropAllQueued();case 45:e.next=51;break;case 47:return e.prev=47,e.t0=e.catch(0),a=e.t0,e.abrupt("return",this.instance.Events.trigger("error",a));case 51:case"end":return e.stop()}}),e,this,[[0,47]])}))),function(e,t){return c.apply(this,arguments)})},{key:"__disconnect__",value:function(e){return clearInterval(this.heartbeat),this.sharedConnection?this.connection.__removeLimiter__(this.instance):this.connection.disconnect(e)}},{key:"runScript",value:(a=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n){var r=this;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if("init"===t||"register_client"===t){e.next=3;break}return e.next=3,this.ready;case 3:return e.abrupt("return",new this.Promise((function(e,i){var s,o;return s=[Date.now(),r.clientId].concat(n),r.instance.Events.trigger("debug","Calling Redis script: ".concat(t,".lua"),s),o=r.connection.__scriptArgs__(t,r.originalId,s,(function(t,n){return null!=t?i(t):e(n)})),r.connection.__scriptFn__(t).apply(void 0,_toConsumableArray(o))})).catch((function(e){return"SETTINGS_KEY_NOT_FOUND"===e.message?"heartbeat"===t?r.Promise.resolve():r.runScript("init",r.prepareInitSettings(!1)).then((function(){return r.runScript(t,n)})):"UNKNOWN_CLIENT"===e.message?r.runScript("register_client",[r.instance.queued()]).then((function(){return r.runScript(t,n)})):r.Promise.reject(e)})));case 4:case"end":return e.stop()}}),e,this)}))),function(e,t){return a.apply(this,arguments)})},{key:"prepareArray",value:function(e){var t,n,r,i;for(r=[],t=0,n=e.length;t<n;t++)i=e[t],r.push(null!=i?i.toString():"");return r}},{key:"prepareObject",value:function(e){var t,n,r;for(n in t=[],e)r=e[n],t.push(n,null!=r?r.toString():"");return t}},{key:"prepareInitSettings",value:function(e){var t;return(t=this.prepareObject(Object.assign({},this.storeOptions,{id:this.originalId,version:this.instance.version,groupTimeout:this.timeout,clientTimeout:this.clientTimeout}))).unshift(e?1:0,this.instance.version),t}},{key:"convertBool",value:function(e){return!!e}},{key:"__updateSettings__",value:(o=_asyncToGenerator(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.runScript("update_settings",this.prepareObject(t));case 2:return e.abrupt("return",parser$5.overwrite(t,t,this.storeOptions));case 3:case"end":return e.stop()}}),e,this)}))),function(e){return o.apply(this,arguments)})},{key:"__running__",value:function(){return this.runScript("running",[])}},{key:"__queued__",value:function(){return this.runScript("queued",[])}},{key:"__done__",value:function(){return this.runScript("done",[])}},{key:"__groupCheck__",value:(s=_asyncToGenerator(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=this,e.next=3,this.runScript("group_check",[]);case 3:return e.t1=e.sent,e.abrupt("return",e.t0.convertBool.call(e.t0,e.t1));case 5:case"end":return e.stop()}}),e,this)}))),function(){return s.apply(this,arguments)})},{key:"__incrementReservoir__",value:function(e){return this.runScript("increment_reservoir",[e])}},{key:"__currentReservoir__",value:function(){return this.runScript("current_reservoir",[])}},{key:"__check__",value:(i=_asyncToGenerator(regeneratorRuntime.mark((function e(t){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.t0=this,e.next=3,this.runScript("check",this.prepareArray([t]));case 3:return e.t1=e.sent,e.abrupt("return",e.t0.convertBool.call(e.t0,e.t1));case 5:case"end":return e.stop()}}),e,this)}))),function(e){return i.apply(this,arguments)})},{key:"__register__",value:(r=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n,r){var i,s,o,a,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.runScript("register",this.prepareArray([t,n,r]));case 2:return a=e.sent,c=_slicedToArray(a,3),s=c[0],o=c[1],i=c[2],e.abrupt("return",{success:this.convertBool(s),wait:o,reservoir:i});case 8:case"end":return e.stop()}}),e,this)}))),function(e,t,n){return r.apply(this,arguments)})},{key:"__submit__",value:(n=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n){var r,i,s,o,a,c,u,l,h;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this.runScript("submit",this.prepareArray([t,n]));case 3:return c=e.sent,u=_slicedToArray(c,3),o=u[0],r=u[1],a=u[2],e.abrupt("return",{reachedHWM:this.convertBool(o),blocked:this.convertBool(r),strategy:a});case 11:if(e.prev=11,e.t0=e.catch(0),0!==(i=e.t0).message.indexOf("OVERWEIGHT")){e.next=23;break}throw l=i.message.split(":"),(h=_slicedToArray(l,3))[0],n=h[1],s=h[2],new BottleneckError$3("Impossible to add a job having a weight of ".concat(n," to a limiter having a maxConcurrent setting of ").concat(s));case 23:throw i;case 24:case"end":return e.stop()}}),e,this,[[0,11]])}))),function(e,t){return n.apply(this,arguments)})},{key:"__free__",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n){var r;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.runScript("free",this.prepareArray([t]));case 2:return r=e.sent,e.abrupt("return",{running:r});case 4:case"end":return e.stop()}}),e,this)}))),function(e,n){return t.apply(this,arguments)})}]),e}();var RedisDatastore_1=RedisDatastore,BottleneckError$4,States;BottleneckError$4=BottleneckError_1,States=function(){function e(t){_classCallCheck(this,e),this.status=t,this._jobs={},this.counts=this.status.map((function(){return 0}))}return _createClass(e,[{key:"next",value:function(e){var t,n;return n=(t=this._jobs[e])+1,null!=t&&n<this.status.length?(this.counts[t]--,this.counts[n]++,this._jobs[e]++):null!=t?(this.counts[t]--,delete this._jobs[e]):void 0}},{key:"start",value:function(e){return this._jobs[e]=0,this.counts[0]++}},{key:"remove",value:function(e){var t;return null!=(t=this._jobs[e])&&(this.counts[t]--,delete this._jobs[e]),null!=t}},{key:"jobStatus",value:function(e){var t;return null!=(t=this.status[this._jobs[e]])?t:null}},{key:"statusJobs",value:function(e){var t,n,r,i;if(null!=e){if((n=this.status.indexOf(e))<0)throw new BottleneckError$4("status must be one of ".concat(this.status.join(", ")));for(t in i=[],r=this._jobs)r[t]===n&&i.push(t);return i}return Object.keys(this._jobs)}},{key:"statusCounts",value:function(){var e=this;return this.counts.reduce((function(t,n,r){return t[e.status[r]]=n,t}),{})}}]),e}();var States_1=States,DLList$2,Sync;DLList$2=DLList_1,Sync=function(){function e(t,n){_classCallCheck(this,e),this.schedule=this.schedule.bind(this),this.name=t,this.Promise=n,this._running=0,this._queue=new DLList$2}var t;return _createClass(e,[{key:"isEmpty",value:function(){return 0===this._queue.length}},{key:"_tryToRun",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t,n,r,i,s,o,a,c;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!(this._running<1&&this._queue.length>0)){e.next=13;break}return this._running++,c=this._queue.shift(),a=c.task,t=c.args,s=c.resolve,i=c.reject,e.next=9,_asyncToGenerator(regeneratorRuntime.mark((function e(){return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,a.apply(void 0,_toConsumableArray(t));case 3:return o=e.sent,e.abrupt("return",(function(){return s(o)}));case 7:return e.prev=7,e.t0=e.catch(0),r=e.t0,e.abrupt("return",(function(){return i(r)}));case 11:case"end":return e.stop()}}),e,null,[[0,7]])})))();case 9:return n=e.sent,this._running--,this._tryToRun(),e.abrupt("return",n());case 13:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"schedule",value:function(e){var t,n,r;r=n=null,t=new this.Promise((function(e,t){return r=e,n=t}));for(var i=arguments.length,s=new Array(i>1?i-1:0),o=1;o<i;o++)s[o-1]=arguments[o];return this._queue.push({task:e,args:s,resolve:r,reject:n}),this._tryToRun(),t}}]),e}();var Sync_1=Sync,version="2.19.5",version$1={version:version},version$2=Object.freeze({version:version,default:version$1}),Events$4,Group,IORedisConnection$2,RedisConnection$2,Scripts$3,parser$6;parser$6=parser,Events$4=Events_1,RedisConnection$2=RedisConnection_1,IORedisConnection$2=IORedisConnection_1,Scripts$3=Scripts,Group=function(){var e=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e),this.deleteKey=this.deleteKey.bind(this),this.limiterOptions=t,parser$6.load(this.limiterOptions,this.defaults,this),this.Events=new Events$4(this),this.instances={},this.Bottleneck=Bottleneck_1,this._startAutoCleanup(),this.sharedConnection=null!=this.connection,null==this.connection&&("redis"===this.limiterOptions.datastore?this.connection=new RedisConnection$2(Object.assign({},this.limiterOptions,{Events:this.Events})):"ioredis"===this.limiterOptions.datastore&&(this.connection=new IORedisConnection$2(Object.assign({},this.limiterOptions,{Events:this.Events}))))}var t,n;return _createClass(e,[{key:"key",value:function(){var e,t,n=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"";return null!=(e=this.instances[r])?e:(t=n.instances[r]=new n.Bottleneck(Object.assign(n.limiterOptions,{id:"".concat(n.id,"-").concat(r),timeout:n.timeout,connection:n.connection})),n.Events.trigger("created",t,r),t)}},{key:"deleteKey",value:(n=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t,n,r,i=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t=i.length>0&&void 0!==i[0]?i[0]:"",r=this.instances[t],!this.connection){e.next=6;break}return e.next=5,this.connection.__runCommand__(["del"].concat(_toConsumableArray(Scripts$3.allKeys("".concat(this.id,"-").concat(t)))));case 5:n=e.sent;case 6:if(null==r){e.next=10;break}return delete this.instances[t],e.next=10,r.disconnect();case 10:return e.abrupt("return",null!=r||n>0);case 11:case"end":return e.stop()}}),e,this)}))),function(){return n.apply(this,arguments)})},{key:"limiters",value:function(){var e,t,n,r;for(e in n=[],t=this.instances)r=t[e],n.push({key:e,limiter:r});return n}},{key:"keys",value:function(){return Object.keys(this.instances)}},{key:"clusterKeys",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t,n,r,i,s,o,a,c,u,l,h;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(null!=this.connection){e.next=2;break}return e.abrupt("return",this.Promise.resolve(this.keys()));case 2:o=[],t=null,u="b_".concat(this.id,"-").length,n="_settings".length;case 6:if(0===t){e.next=17;break}return e.next=9,this.connection.__runCommand__(["scan",null!=t?t:0,"match","b_".concat(this.id,"-*_settings"),"count",1e4]);case 9:for(l=e.sent,h=_slicedToArray(l,2),c=h[0],r=h[1],t=~~c,i=0,a=r.length;i<a;i++)s=r[i],o.push(s.slice(u,-n));e.next=6;break;case 17:return e.abrupt("return",o);case 18:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"_startAutoCleanup",value:function(){var e,t=this;return clearInterval(this.interval),"function"==typeof(e=this.interval=setInterval(_asyncToGenerator(regeneratorRuntime.mark((function e(){var n,r,i,s,o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:o=Date.now(),i=t.instances,s=[],e.t0=regeneratorRuntime.keys(i);case 4:if((e.t1=e.t0()).done){e.next=23;break}return r=e.t1.value,a=i[r],e.prev=7,e.next=10,a._store.__groupCheck__(o);case 10:if(!e.sent){e.next=14;break}s.push(t.deleteKey(r)),e.next=15;break;case 14:s.push(void 0);case 15:e.next=21;break;case 17:e.prev=17,e.t2=e.catch(7),n=e.t2,s.push(a.Events.trigger("error",n));case 21:e.next=4;break;case 23:return e.abrupt("return",s);case 24:case"end":return e.stop()}}),e,null,[[7,17]])}))),this.timeout/2)).unref?e.unref():void 0}},{key:"updateSettings",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(parser$6.overwrite(e,this.defaults,this),parser$6.overwrite(e,e,this.limiterOptions),null!=e.timeout)return this._startAutoCleanup()}},{key:"disconnect",value:function(){var e,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(!this.sharedConnection)return null!=(e=this.connection)?e.disconnect(t):void 0}}]),e}();return e.prototype.defaults={timeout:3e5,connection:null,Promise:Promise,id:"group-key"},e}.call(commonjsGlobal);var Group_1=Group,Batcher,Events$5,parser$7;parser$7=parser,Events$5=Events_1,Batcher=function(){var e=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e),this.options=t,parser$7.load(this.options,this.defaults,this),this.Events=new Events$5(this),this._arr=[],this._resetPromise(),this._lastFlush=Date.now()}return _createClass(e,[{key:"_resetPromise",value:function(){var e=this;return this._promise=new this.Promise((function(t,n){return e._resolve=t}))}},{key:"_flush",value:function(){return clearTimeout(this._timeout),this._lastFlush=Date.now(),this._resolve(),this.Events.trigger("batch",this._arr),this._arr=[],this._resetPromise()}},{key:"add",value:function(e){var t,n=this;return this._arr.push(e),t=this._promise,this._arr.length===this.maxSize?this._flush():null!=this.maxTime&&1===this._arr.length&&(this._timeout=setTimeout((function(){return n._flush()}),this.maxTime)),t}}]),e}();return e.prototype.defaults={maxTime:null,maxSize:null,Promise:Promise},e}.call(commonjsGlobal);var Batcher_1=Batcher,require$$8=getCjsExportFromNamespace(version$2),Bottleneck,DEFAULT_PRIORITY$1,Events$6,Job$1,LocalDatastore$1,NUM_PRIORITIES$1,Queues$1,RedisDatastore$1,States$1,Sync$1,parser$8,splice=[].splice;NUM_PRIORITIES$1=10,DEFAULT_PRIORITY$1=5,parser$8=parser,Queues$1=Queues_1,Job$1=Job_1,LocalDatastore$1=LocalDatastore_1,RedisDatastore$1=RedisDatastore_1,Events$6=Events_1,States$1=States_1,Sync$1=Sync_1,Bottleneck=function(){var e=function(){function e(){var t,n,r=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,e),this._addToQueue=this._addToQueue.bind(this);for(var s=arguments.length,o=new Array(s>1?s-1:0),a=1;a<s;a++)o[a-1]=arguments[a];this._validateOptions(i,o),parser$8.load(i,this.instanceDefaults,this),this._queues=new Queues$1(NUM_PRIORITIES$1),this._scheduled={},this._states=new States$1(["RECEIVED","QUEUED","RUNNING","EXECUTING"].concat(this.trackDoneStatus?["DONE"]:[])),this._limiter=null,this.Events=new Events$6(this),this._submitLock=new Sync$1("submit",this.Promise),this._registerLock=new Sync$1("register",this.Promise),n=parser$8.load(i,this.storeDefaults,{}),this._store=function(){if("redis"===this.datastore||"ioredis"===this.datastore||null!=this.connection)return t=parser$8.load(i,this.redisStoreDefaults,{}),new RedisDatastore$1(this,n,t);if("local"===this.datastore)return t=parser$8.load(i,this.localStoreDefaults,{}),new LocalDatastore$1(this,n,t);throw new e.prototype.BottleneckError("Invalid datastore type: ".concat(this.datastore))}.call(this),this._queues.on("leftzero",(function(){var e;return null!=(e=r._store.heartbeat)&&"function"==typeof e.ref?e.ref():void 0})),this._queues.on("zero",(function(){var e;return null!=(e=r._store.heartbeat)&&"function"==typeof e.unref?e.unref():void 0}))}var t,n,r;return _createClass(e,[{key:"_validateOptions",value:function(t,n){if(null==t||"object"!==_typeof(t)||0!==n.length)throw new e.prototype.BottleneckError("Bottleneck v2 takes a single object argument. Refer to https://github.com/SGrondin/bottleneck#upgrading-to-v2 if you're upgrading from Bottleneck v1.")}},{key:"ready",value:function(){return this._store.ready}},{key:"clients",value:function(){return this._store.clients}},{key:"channel",value:function(){return"b_".concat(this.id)}},{key:"channel_client",value:function(){return"b_".concat(this.id,"_").concat(this._store.clientId)}},{key:"publish",value:function(e){return this._store.__publish__(e)}},{key:"disconnect",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this._store.__disconnect__(e)}},{key:"chain",value:function(e){return this._limiter=e,this}},{key:"queued",value:function(e){return this._queues.queued(e)}},{key:"clusterQueued",value:function(){return this._store.__queued__()}},{key:"empty",value:function(){return 0===this.queued()&&this._submitLock.isEmpty()}},{key:"running",value:function(){return this._store.__running__()}},{key:"done",value:function(){return this._store.__done__()}},{key:"jobStatus",value:function(e){return this._states.jobStatus(e)}},{key:"jobs",value:function(e){return this._states.statusJobs(e)}},{key:"counts",value:function(){return this._states.statusCounts()}},{key:"_randomIndex",value:function(){return Math.random().toString(36).slice(2)}},{key:"check",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;return this._store.__check__(e)}},{key:"_clearGlobalState",value:function(e){return null!=this._scheduled[e]&&(clearTimeout(this._scheduled[e].expiration),delete this._scheduled[e],!0)}},{key:"_free",value:(r=_asyncToGenerator(regeneratorRuntime.mark((function e(t,n,r,i){var s,o,a;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,this._store.__free__(t,r.weight);case 3:if(a=e.sent,o=a.running,this.Events.trigger("debug","Freed ".concat(r.id),i),0!==o||!this.empty()){e.next=8;break}return e.abrupt("return",this.Events.trigger("idle"));case 8:e.next=14;break;case 10:return e.prev=10,e.t0=e.catch(0),s=e.t0,e.abrupt("return",this.Events.trigger("error",s));case 14:case"end":return e.stop()}}),e,this,[[0,10]])}))),function(e,t,n,i){return r.apply(this,arguments)})},{key:"_run",value:function(e,t,n){var r,i,s,o=this;return t.doRun(),r=this._clearGlobalState.bind(this,e),s=this._run.bind(this,e,t),i=this._free.bind(this,e,t),this._scheduled[e]={timeout:setTimeout((function(){return t.doExecute(o._limiter,r,s,i)}),n),expiration:null!=t.options.expiration?setTimeout((function(){return t.doExpire(r,s,i)}),n+t.options.expiration):void 0,job:t}}},{key:"_drainOne",value:function(e){var t=this;return this._registerLock.schedule((function(){var n,r,i,s,o;if(0===t.queued())return t.Promise.resolve(null);o=t._queues.getFirst();var a=i=o.first();return s=a.options,n=a.args,null!=e&&s.weight>e?t.Promise.resolve(null):(t.Events.trigger("debug","Draining ".concat(s.id),{args:n,options:s}),r=t._randomIndex(),t._store.__register__(r,s.weight,s.expiration).then((function(e){var a,c=e.success,u=e.wait,l=e.reservoir;return t.Events.trigger("debug","Drained ".concat(s.id),{success:c,args:n,options:s}),c?(o.shift(),(a=t.empty())&&t.Events.trigger("empty"),0===l&&t.Events.trigger("depleted",a),t._run(r,i,u),t.Promise.resolve(s.weight)):t.Promise.resolve(null)})))}))}},{key:"_drainAll",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return this._drainOne(e).then((function(r){var i;return null!=r?(i=null!=e?e-r:e,t._drainAll(i,n+r)):t.Promise.resolve(n)})).catch((function(e){return t.Events.trigger("error",e)}))}},{key:"_dropAllQueued",value:function(e){return this._queues.shiftAll((function(t){return t.doDrop({message:e})}))}},{key:"stop",value:function(){var t,n,r=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return i=parser$8.load(i,this.stopDefaults),n=function(e){var t;return t=function(){var t;return(t=r._states.counts)[0]+t[1]+t[2]+t[3]===e},new r.Promise((function(e,n){return t()?e():r.on("done",(function(){if(t())return r.removeAllListeners("done"),e()}))}))},t=i.dropWaitingJobs?(this._run=function(e,t){return t.doDrop({message:i.dropErrorMessage})},this._drainOne=function(){return r.Promise.resolve(null)},this._registerLock.schedule((function(){return r._submitLock.schedule((function(){var e,t,s;for(e in t=r._scheduled)s=t[e],"RUNNING"===r.jobStatus(s.job.options.id)&&(clearTimeout(s.timeout),clearTimeout(s.expiration),s.job.doDrop({message:i.dropErrorMessage}));return r._dropAllQueued(i.dropErrorMessage),n(0)}))}))):this.schedule({priority:NUM_PRIORITIES$1-1,weight:0},(function(){return n(1)})),this._receive=function(t){return t._reject(new e.prototype.BottleneckError(i.enqueueErrorMessage))},this.stop=function(){return r.Promise.reject(new e.prototype.BottleneckError("stop() has already been called"))},t}},{key:"_addToQueue",value:(n=_asyncToGenerator(regeneratorRuntime.mark((function t(n){var r,i,s,o,a,c,u,l;return regeneratorRuntime.wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return r=n.args,o=n.options,t.prev=2,t.next=5,this._store.__submit__(this.queued(),o.weight);case 5:l=t.sent,a=l.reachedHWM,i=l.blocked,u=l.strategy,t.next=17;break;case 11:return t.prev=11,t.t0=t.catch(2),s=t.t0,this.Events.trigger("debug","Could not queue ".concat(o.id),{args:r,options:o,error:s}),n.doDrop({error:s}),t.abrupt("return",!1);case 17:if(!i){t.next=22;break}return n.doDrop(),t.abrupt("return",!0);case 22:if(!a){t.next=28;break}if(null!=(c=u===e.prototype.strategy.LEAK?this._queues.shiftLastFrom(o.priority):u===e.prototype.strategy.OVERFLOW_PRIORITY?this._queues.shiftLastFrom(o.priority+1):u===e.prototype.strategy.OVERFLOW?n:void 0)&&c.doDrop(),null!=c&&u!==e.prototype.strategy.OVERFLOW){t.next=28;break}return null==c&&n.doDrop(),t.abrupt("return",a);case 28:return n.doQueue(a,i),this._queues.push(n),t.next=32,this._drainAll();case 32:return t.abrupt("return",a);case 33:case"end":return t.stop()}}),t,this,[[2,11]])}))),function(e){return n.apply(this,arguments)})},{key:"_receive",value:function(t){return null!=this._states.jobStatus(t.options.id)?(t._reject(new e.prototype.BottleneckError("A job with the same id already exists (id=".concat(t.options.id,")"))),!1):(t.doReceive(),this._submitLock.schedule(this._addToQueue,t))}},{key:"submit",value:function(){for(var e,t,n,r,i,s,o,a,c,u=this,l=arguments.length,h=new Array(l),_=0;_<l;_++)h[_]=arguments[_];return"function"==typeof h[0]?(s=_toArray(h),t=s[0],h=s.slice(1),o=_slicedToArray(splice.call(h,-1),1),e=o[0],r=parser$8.load({},this.jobDefaults)):(r=(a=_toArray(h))[0],t=a[1],h=a.slice(2),c=_slicedToArray(splice.call(h,-1),1),e=c[0],r=parser$8.load(r,this.jobDefaults)),i=function(){for(var e=arguments.length,n=new Array(e),r=0;r<e;r++)n[r]=arguments[r];return new u.Promise((function(e,r){return t.apply(void 0,n.concat([function(){for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];return(null!=n[0]?r:e)(n)}]))}))},(n=new Job$1(i,h,r,this.jobDefaults,this.rejectOnDrop,this.Events,this._states,this.Promise)).promise.then((function(t){return"function"==typeof e?e.apply(void 0,_toConsumableArray(t)):void 0})).catch((function(t){return Array.isArray(t)?"function"==typeof e?e.apply(void 0,_toConsumableArray(t)):void 0:"function"==typeof e?e(t):void 0})),this._receive(n)}},{key:"schedule",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];var r,i,s;if("function"==typeof t[0]){var o=t,a=_toArray(o);s=a[0],t=a.slice(1),i={}}else{var c=t,u=_toArray(c);i=u[0],s=u[1],t=u.slice(2)}return r=new Job$1(s,t,i,this.jobDefaults,this.rejectOnDrop,this.Events,this._states,this.Promise),this._receive(r),r.promise}},{key:"wrap",value:function(e){var t,n;return t=this.schedule.bind(this),n=function(){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return t.apply(void 0,[e.bind(this)].concat(r))},n.withOptions=function(n){for(var r=arguments.length,i=new Array(r>1?r-1:0),s=1;s<r;s++)i[s-1]=arguments[s];return t.apply(void 0,[n,e].concat(i))},n}},{key:"updateSettings",value:(t=_asyncToGenerator(regeneratorRuntime.mark((function e(){var t,n=arguments;return regeneratorRuntime.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t=n.length>0&&void 0!==n[0]?n[0]:{},e.next=3,this._store.__updateSettings__(parser$8.overwrite(t,this.storeDefaults));case 3:return parser$8.overwrite(t,this.instanceDefaults,this),e.abrupt("return",this);case 5:case"end":return e.stop()}}),e,this)}))),function(){return t.apply(this,arguments)})},{key:"currentReservoir",value:function(){return this._store.__currentReservoir__()}},{key:"incrementReservoir",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return this._store.__incrementReservoir__(e)}}]),e}();return e.default=e,e.Events=Events$6,e.version=e.prototype.version=require$$8.version,e.strategy=e.prototype.strategy={LEAK:1,OVERFLOW:2,OVERFLOW_PRIORITY:4,BLOCK:3},e.BottleneckError=e.prototype.BottleneckError=BottleneckError_1,e.Group=e.prototype.Group=Group_1,e.RedisConnection=e.prototype.RedisConnection=RedisConnection_1,e.IORedisConnection=e.prototype.IORedisConnection=IORedisConnection_1,e.Batcher=e.prototype.Batcher=Batcher_1,e.prototype.jobDefaults={priority:DEFAULT_PRIORITY$1,weight:1,expiration:null,id:"<no-id>"},e.prototype.storeDefaults={maxConcurrent:null,minTime:0,highWater:null,strategy:e.prototype.strategy.LEAK,penalty:null,reservoir:null,reservoirRefreshInterval:null,reservoirRefreshAmount:null,reservoirIncreaseInterval:null,reservoirIncreaseAmount:null,reservoirIncreaseMaximum:null},e.prototype.localStoreDefaults={Promise:Promise,timeout:null,heartbeatInterval:250},e.prototype.redisStoreDefaults={Promise:Promise,timeout:null,heartbeatInterval:5e3,clientTimeout:1e4,Redis:null,clientOptions:{},clusterNodes:null,clearDatastore:!1,connection:null},e.prototype.instanceDefaults={datastore:"local",connection:null,id:"<no-id>",rejectOnDrop:!0,trackDoneStatus:!1,Promise:Promise},e.prototype.stopDefaults={enqueueErrorMessage:"This limiter has been stopped and cannot accept new jobs.",dropWaitingJobs:!0,dropErrorMessage:"This limiter has been stopped."},e}.call(commonjsGlobal);var Bottleneck_1=Bottleneck,es5=Bottleneck_1;return es5},module.exports=factory()},268:function(e){"use strict";e.exports=__WEBPACK_EXTERNAL_MODULE__268__}},__webpack_module_cache__={};function __webpack_require__(e){var t=__webpack_module_cache__[e];if(void 0!==t)return t.exports;var n=__webpack_module_cache__[e]={exports:{}};return __webpack_modules__[e].call(n.exports,n,n.exports,__webpack_require__),n.exports}__webpack_require__.d=function(e,t){for(var n in t)__webpack_require__.o(t,n)&&!__webpack_require__.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},__webpack_require__.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),__webpack_require__.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},__webpack_require__.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};var __webpack_exports__={};return function(){"use strict";function e(t){return e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},e(t)}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{assetMeta:function(){return h},children:function(){return c},html:function(){return l},meta:function(){return u}});var t=__webpack_require__(268),n=__webpack_require__(601),r="https://www.canada.ca/",i=new n({reservoir:100,reservoirRefreshAmount:100,reservoirRefreshInterval:3e4,maxConcurrent:5});function s(){return"?_="+(new Date).getTime()}function o(t){if("string"==typeof t&&(t={path:t}),"object"===e(t)&&"string"==typeof t.path){var n=t.path.match(/(^|\/)(en|fr)(\/?[^\.?]*|$)/);if(!n)throw new Error("Invalid node path "+t.path);return t.path=n[0].replace(/^\/|\/$/g,""),t}throw new Error("Invalid node")}function a(e){if(!e.ok)throw new Error(e.statusText);if(0!==e.url.indexOf(r))throw new Error("Redirect");if(-1!==e.url.indexOf("/errors/404.html"))throw new Error("Not Found");return"application/json;charset=utf-8"===e.headers.get("content-type")?e.json():e.text()}function c(e,n){return n=o(n),i.schedule((function(){return t(r+n.path+".sitemap.xml"+s())})).then(a).then((function(t){var n=0==e.length;return t.match(/<url>(.*?)<\/url>/g).forEach((function(t){var r=o(t).path,i=Date.parse(t.match(/\d{4}-\d{2}-\d{2}/)[0])/1e3;if(!n)for(var s=e.length-1;s>=0;s--)if(e[s].path===r)return void(e[s].lastmod=i);e.push({path:r,lastmod:i})})),e})).catch((function(t){return console.error(t),e}))}function u(e){return e=o(e),i.schedule((function(){return t(r+e.path+"/jcr:content.json"+s())})).then(a).then((function(t){for(var n in t)"true"===t[n]?t[n]=!0:"false"===t[n]?t[n]=!1:-1!==n.indexOf("@TypeHint")?delete t[n]:/[\d\:]{8} \w{3}-\d{4}$/.test(t[n])&&(t[n]=Date.parse(t[n])/1e3);return e.meta=t,e})).catch((function(t){return e.meta=t,e}))}function l(e){return e=o(e),i.schedule((function(){t(r+e.path+".html"+s())})).then(a).then((function(t){return e.html=t.trim().replace(/\s{2,}/g," "),e})).catch((function(t){return e.html=t,e}))}function h(e){return e=function(e){if("string"==typeof e){var t=e.match(/(^|\/)content\/dam\/([^?]*|$)/);if(!t)throw new Error("Invalid asset path "+e);return t[0].replace(/^\/|\/$/g,"")}throw new Error("Invalid asset")}(e),i.schedule((function(){t(r+e+"/jcr:content.json"+s())})).then(a).then((function(t){return t.path=e,t})).catch((function(e){return e}))}}(),__webpack_exports__}()}));